(function () { "use strict"; var app = { favicon: "/favicon.ico", bootLogo: "/BRVisu/assets/img/br_logo.png", bootColor: "#FF8800", visuStyle: "/BRVisu/release/brease_core.min.css", defaultVisu: void 0, start: function () { return window.brease || (window.brease = {}), window.brease.preloaded = {}, app.defaultVisu = void 0, app.visuList = void 0, app.params = app.urlParser(window.location.pathname, window.location.search), Promise.all([_loadJSON("/services/server/getConfiguration").then(_getConfigurationResponseHandler), _loadJSON("/0_visulist.json").then(_getVisuListResponseHandler)]).then(_startRedirect) }, getClientInfo: function (e) { var t = { hostname: document.location.hostname ? document.location.hostname : "", browser: platform.name ? platform.name : "", operatingsystem: platform.os.family ? platform.os.family : "", aspectratio: screen.width && screen.height ? roundTo(screen.width / screen.height, 2) : 1, orientation: window.matchMedia("(orientation: landscape)").matches ? "landscape" : "portrait", displaywidth: screen.width ? screen.width : 0, displayheight: screen.height ? screen.height : 0 }; _requestClientIpAdress((function getClientIpSuccess(i) { var o = i ? "" + i : ""; t.ipaddress = new Ipaddress(o), "function" == typeof e && e(t) })) }, interpretClientRules: function (arrRules, clientInfo) { return arrRules.filter((function (actRule) { var ipaddress = this.ipaddress, hostname = this.hostname, browser = this.browser, operatingsystem = this.operatingsystem, aspectratio = this.aspectratio, orientation = this.orientation, displaywidth = this.displaywidth, displayheight = this.displayheight; return eval(actRule.op) }), clientInfo).map((function (e) { return { name: e.name, visuid: e.visu.toLowerCase() } })) }, getRules: function (e) { var t = [], i, o; if ("string" == typeof e && e.length > 0) { try { o = JSON.parse(e) } catch (e) { return "error" } i = o.redirectconfig } if (!i) return "noConfigurations"; if (0 === Object.getOwnPropertyNames(i).length) return "noRules"; for (var a in i) t.push({ name: a, visu: i[a].visu, op: i[a].op }); return t }, urlParser: function (e, t) { var i = {}; if (0 === t.lastIndexOf("?")) for (var o = (t = t.substring(1)).split("&"), a = 0; a < o.length; a += 1) { var n = o[a]; if (-1 !== n.indexOf("=")) { var r = n.split("="); i[r[0].toLowerCase()] = r[1].toLowerCase() } } var s = e.substring(1); return "" !== s && -1 === s.indexOf(".") && -1 === s.indexOf("/") && (i.visuid = s.toLowerCase()), i }, scriptLoader: function (e, t) { var i = document.createElement("script"); for (var o in e) i.setAttribute(o, e[o]); i.readyState ? i.onreadystatechange = function () { "loaded" !== i.readyState && "complete" !== i.readyState || (i.onreadystatechange = null, "function" == typeof t && t()) } : i.onload = function () { "function" == typeof t && t(), i.onload = null }, document.body.appendChild(i) }, scriptExecutor: function (e, t) { var i = {}; t && (i.id = t), _addElement("script", i, document.body, e) }, logger: function (e, t, i, o, a, n) { a && console.log(a); var r = new XMLHttpRequest, s = [{ eventId: e, verboseLvl: t, text: i || "", args: o }], p = "", d = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/services/server/sendEventLog"; try { p = JSON.stringify({ Data: s }) } catch (e) { return } r.onreadystatechange = function () { 4 === this.readyState && "function" == typeof n && n() }, r.open("POST", d, !0), r.setRequestHeader("Content-Type", "application/json; charset=utf-8"), r.setRequestHeader("Cache-Control", "no-cache"), r.setRequestHeader("Accept", "*/*"), r.send(p) }, showUserMessage: function (e) { var t = document.getElementById("appContainer"); t.textContent = e, t.style.fontSize = "22px" }, visuStarter: function (e) { var t = e.configurations; _setFavicon(t), _loadImage(t, (function (e, i) { _setSplashscreen(t, e, i), _loadVisuStyle() })) } }, HTTP_STATUS_CODE = { OK: 200, NOT_FOUND: 404 }; function _getConfigurationResponseHandler(e) { if (!0 === e.success) { var t; try { t = JSON.parse(e.strJSON) } catch (e) { return app.showUserMessage("error in configuration file"), void 0 } void 0 !== t && t.status && 0 === t.status.code && (Object.defineProperty(window.brease.preloaded, "configuration", { enumerable: !0, configurable: !0, writable: !1, value: t.configuration }), t.configuration && t.configuration.defaultVisu && (app.defaultVisu = t.configuration.defaultVisu.toLowerCase())) } else app.showUserMessage("loading configuration: " + e.cause) } function _getVisuListResponseHandler(e) { if (!0 === e.success) { var t; try { t = JSON.parse(e.strJSON) } catch (e) { console.log("error in visu list") } void 0 !== t && (app.visuList = t) } } function _startRedirect() { _isMapp(app.params.visuid) ? _start() : (app.params.visuid===undefined&&Array.isArray(app.visuList)&&1===app.visuList.length&&(app.defaultVisu=app.visuList[0],app.params.visuid=app.visuList[0]),_parseRules())}function _parseRules(){_loadJSON("/services/server/getRedirectConfig").then((function(e){var t=app.getRules(e.strJSON);"noRules"===t?void 0===app.defaultVisu?(app.showUserMessage("no rules in redirect configuration are specified and no default visualization is found"),app.logger(-2134803120,0,"",["noConfig"],"no rules in redirect configuration are specified and no default visualization is found")):(app.params.visuid=app.defaultVisu?app.defaultVisu.toLowerCase():app.defaultVisu,_start()):"error"===t?app.showUserMessage("error in rules file redirect.json"):"noConfigurations"===t?(void 0===app.params.visuid&&(app.params.visuid=app.defaultVisu?app.defaultVisu.toLowerCase():app.defaultVisu),_start()):_checkRules(t,_processRulesResult)}))}function _processRulesResult(e){void 0!==e.find((function(e){return e.visuid===app.params.visuid}))?_start():void 0!==e[0]?void 0!==app.params.visuid&&app.params.visuid!==app.defaultVisu?app.logger(-2134803126,0,"",[app.params.visuid],'the requested visualization "'+app.params.visuid+'" was blocked due to configured redirect rules',(function(){_redirectVisu(e[0].visuid,e[0].name)})):_redirectVisu(e[0].visuid,e[0].name):void 0!==app.defaultVisu?void 0!==app.params.visuid&&app.params.visuid!==app.defaultVisu?app.logger(-2134803126,0,"",[app.params.visuid],'the requested visualization "'+app.params.visuid+'" was blocked due to configured redirect rules',(function(){_redirectVisu(app.defaultVisu)})):_redirectVisu(app.defaultVisu):void 0===app.params.visuid?app.showUserMessage("no visuId specified"):app.showUserMessage('the requested visualization "'+app.params.visuid+'" was blocked due to configured redirect rules')}function _redirectVisu(e,t){void 0===t?console.log("redirect client to default visualization:"+e):console.log('redirect client to visualization "'+e+'" due to rule:'+t),app.params.visuid=e,_start()}function _start(){if(void 0===app.params.visuid)return app.showUserMessage("no visuId specified"),void 0;app.params.visuid=app.params.visuid.toLowerCase(),document.title="Visualization "+app.params.visuid,_loadVisu(app.params.visuid)}function _loadVisu(e){_loadJSON("/"+e+".json").then((function(t){if(!0===t.success){var i;try{i=JSON.parse(t.strJSON)}catch(t){return app.showUserMessage("error in visu file "+e+".json"),void 0}i.id=e,Object.defineProperty(window.brease.preloaded,"visu",{enumerable:!0,configurable:!0,writable:!1,value:i}),app.visuStarter(i)}else app.showUserMessage('loading visu with id "'+e+'" failed: '+t.cause)}))}function _initBrease(){"true"===app.params.debug?app.scriptLoader({src:"libs/require.js","data-main":"require_config"},_startBrease):app.scriptLoader({src:"release/brease.js"},_startBrease)}function _createConfig(){var e={warn:void 0!==app.params.clientwarnings&&"true"===app.params.clientwarnings.toLowerCase(),editMode:void 0!==app.params.editmode&&"true"===app.params.editmode.toLowerCase(),detection:{mobile:_checkMobile(),os:platform&&platform.os?platform.os.family:navigator.platform,browser:platform.name},watchdog:void 0!==app.params.watchdog?parseInt(app.params.watchdog,10):void 0,storageLog:void 0!==app.params.storagelog&&"true"===app.params.storagelog.toLowerCase()};return platform&&platform.os&&platform.os.family?e.detection.ios="ios"===platform.os.family.toLowerCase():e.detection.ios=-1!==navigator.platform.search(/(iphone|ipod|ipad)/gi),e}function _startBrease(){requirejs.onError=function(e){"timeout"===e.requireType&&window._connectionErrorHandler()};var e=_createConfig();if(_addLogLink(e.storageLog),"true"===app.params.monitor&&-1===document.location.href.indexOf("monitor.html"))return document.location.href="/BRVisu/assets/monitor/monitor.html"+document.location.search,void 0;app.scriptExecutor('require(["brease/application"], function (application) {application.startVisu("'+app.params.visuid+'",'+JSON.stringify(e)+");});");var t=document.getElementById("bootstrapper");t&&document.body.removeChild(t)}function _loadJSON(e){return new Promise((function(t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Accept","*/*"),i.onreadystatechange=function(){var e=parseInt(i.status,10);i.readyState===XMLHttpRequest.DONE&&(e===HTTP_STATUS_CODE.OK?t({strJSON:i.responseText,success:!0}):e===HTTP_STATUS_CODE.NOT_FOUND?t({success:!1,cause:"not found"}):0===e?window._connectionErrorHandler():t({success:!1,cause:"could not load file"}))},i.ontimeout=function(){window._connectionErrorHandler()},i.send(null)}))}function _setFavicon(e){var t=e&&e.favicon?e.favicon:app.favicon,i="image/x-icon";t.lastIndexOf(".gif")>0?i="image/gif":t.lastIndexOf(".png")>0&&(i="image/png"),_addElement("link",{href:t,rel:"icon",type:i},document.head)}function _loadImage(e,t){var i=e&&e.bootLogo?e.bootLogo:app.bootLogo,o=new Image;o.onload=function(){t(!0,o)},o.onerror=function(){t(!1)},o.src=i}function _setSplashscreen(e,t,i){var o=e&&e.bootLogo?e.bootLogo:app.bootLogo,a=e&&e.bootColor?e.bootColor:app.bootColor,n=document.getElementById("splashscreen");if(n){var r=n.style;r.position="fixed",r.top="0",r.left="0",r.width="100%",r.height="100%",r.zIndex="2",!0===t?(r.background=a+" url("+i.src+") no-repeat 50% 50%",(i.width>window.innerWidth||i.height>window.innerHeight)&&(r.backgroundSize="contain")):(r.backgroundColor=a,r.display="inline-flex",r.flexDirection="column",r.flexWrap="nowrap",r.justifyContent="center",r.alignContent="center",r.alignItems="center",_addElement("div",{style:"display:inline-box;width:50%;background-color:white;color:black;font-size:18px;line-height:18px;text-align:center;padding:12px 0;flex:0 0 auto;"},n,"boot image not found: "+o),_addElement("img",{src:app.bootLogo,style:"margin:12px 0;flex:0 0 auto;"},n))}}function _addLogLink(e){!0===e&&_addElement("a",{href:"/BRVisu/assets/log.html?t="+Date.now(),style:"position:fixed;top:5px;left:5px;font-size:18px;line-height:18px;z-index:9;"},document.body,"log")}function onStyleLoad(){_initBrease()}function onStyleError(){"function"==typeof window._connectionErrorHandler&&window._connectionErrorHandler()}function _loadVisuStyle(){if(_stylesheetLoaded(app.visuStyle))_initBrease();else{var e=_addElement("link",{rel:"stylesheet",href:app.visuStyle},document.head);e.addEventListener("load",onStyleLoad),e.addEventListener("error",onStyleError)}}function _addElement(e,t,i,o){var a=document.createElement(e);for(var n in t)a.setAttribute(n,t[n]);return void 0!==o&&(a.textContent=o),i.appendChild(a),a}function _stylesheetLoaded(){var e;return void 0!==_getStylesheetByPath(app.visuStyle.substring(app.visuStyle.lastIndexOf("/release")))}function _getStylesheetByPath(e){var t;if(""!==e)for(var i=0;i<document.styleSheets.length;i+=1){var o=document.styleSheets[i].href;if(o&&-1!==o.indexOf(e)){t=document.styleSheets[i];break}}return t}function _checkMobile(){var e=!1,t=!1,i=navigator.userAgent,o=i||navigator.vendor||window.opera;return(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(o)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(o.substr(0,4)))&&(e=!0),(/(tablet|ipad|playbook|silk)|(android(?!.*mobile))/i.test(i)||-1!==navigator.platform.toLowerCase().indexOf("ipad"))&&(t=!0),e||t}function Ipaddress(e){this.tmpipaddress=this.convert(e)}function _checkRules(e,t){app.getClientInfo((function getClientInfoSuccess(i){var o=app.interpretClientRules(e,i);"function"==typeof t&&t(o)}))}function _requestClientIpAdress(e){var t=new XMLHttpRequest,i=window.location.protocol+"//"+window.location.hostname+(""!==window.location.port?":"+window.location.port:"")+"/client/getIp";t.onreadystatechange=function(){4===this.readyState&&200===this.status&&"function"==typeof e&&e(JSON.parse(this.responseText).ip)},t.open("GET",i,!0),t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("Accept","*/*"),t.send(null)}function roundTo(e,t){var i=Math.pow(10,t);return Math.round(i*e)/i}function _isMapp(e){return"string"==typeof e&&0===e.indexOf("mapp")}Ipaddress.prototype={ge:function(e){return this.gt(e)||this.eq(e)},le:function(e){return this.lt(e)||this.eq(e)},gt:function(e){for(var t=this.convert(e),i=0;i<t.length;i+=1){if(this.tmpipaddress[i]>t[i])return!0;if(this.tmpipaddress[i]<t[i])break}return!1},lt:function(e){for(var t=this.convert(e),i=0;i<t.length;i+=1){if(this.tmpipaddress[i]<t[i])return!0;if(this.tmpipaddress[i]>t[i])break}return!1},eq:function(e){for(var t=this.convert(e),i=!0,o=0;o<t.length;o+=1)i=i&&this.tmpipaddress[o]===t[o];return i},neq:function(e){for(var t=this.convert(e),i=0;i<t.length;i+=1)if(this.tmpipaddress[i]!==t[i])return!0;return!1},convert:function(e){return e.split(".").map((function _parseInt(e){return parseInt(e,10)}))}},"function"==typeof define&&define.amd?define("bootstrapper",[],(function(){return app.Ipaddress=Ipaddress,app})):app.start()})();
